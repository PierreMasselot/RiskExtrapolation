################################################################################
#
#   New extensions
#   2. Vulnerability factors
#
################################################################################

#---------------------
# Reduce dimension
#---------------------

# Select the metapredictors
metapred <- data.matrix(metadata[match(stage2df$city, metadata$CITY_CODE), 
  metaprednames])

# Expand to several age groups
metapred_obs <- metapred[stage2df$obs,]

#----- Compute PLS

# Compute PLSR (basic PLS computed as a linear model)
plsres <- plsr(coefs_obs ~ metapred_obs, scale = T)

# Extract scores for all locations and age
comps <- predict(plsres, newdata = metapred, type = "scores")
colnames(comps) <- sprintf("Comp%i", 1:ncol(metapred))

# Correlation with original metapredictors
coords <- plsres$loadings

#----- Select observed and predicted
comps_obs <- comps[stage2df$obs,]
comps_pred <- comps[!stage2df$obs,]

#------------------
# Plot correlation with initial variables
#------------------

# Select right coordinates
coord_plot <- coords[, 1:npc, drop = F]
rownames(coord_plot) <- names(metaprednames)

# Color scale
pal <- scico(200, palette = "cork")

# Plot coordinates
corrplot(t(coord_plot), method = "square", is.corr = F, col.lim = c(-1, 1), 
  tl.srt = 45, tl.col = "black", cl.cex = .7, cl.align.text = "l",
  col = pal, cl.length = 5) 

# Save

dev.print(pdf, file = "figures/Fig1_compcor.pdf")
